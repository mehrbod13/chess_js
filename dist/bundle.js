(()=>{"use strict";class t{constructor(t){this.pawn=t,this.options=[e.TYPE.QUEEN,e.TYPE.BISHOP,e.TYPE.KNIGHT,e.TYPE.ROOK]}getElement(){let t=document.createElement("div");t.classList.add("promo"),t.style.top=this.pawn.side===e.SIDES.WHITE?"-130%":"130%";for(let i of this.options){let s=document.createElement("div");s.classList.add("option"),s.addEventListener("click",(()=>{this.pawn.promoteTo(i)}));let o=document.createElement("img");o.setAttribute("src",e.getAssest(i,this.pawn.side)),s.appendChild(o),t.appendChild(s)}return t}}class e{static getAssest(t,e){return`./assets/${t}-${e}.svg`}constructor(t,e,i,s,o){this.type=t,this.side=e,this.board=i,this.row=s,this.col=o,this.elem=this.getElement(),this.registerHandler(),this.isMoved=!1}getPosition(){return[this.row,this.col]}getElement(){let t=document.createElement("div");t.classList.add("piece");let i=document.createElement("img");return i.setAttribute("src",e.getAssest(this.type,this.side)),t.appendChild(i),t}getMoves(){return[]}getValidMoves(){return this.getMoves().filter((t=>{var i;return(null===(i=t.square)||void 0===i?void 0:i.type)!==e.TYPE.KING&&this.checkMove(t)}))}move(i,s){var o,h;for(let l of this.getValidMoves())if(s===l.to.col&&i===l.to.row){if(l.isCastle&&(6===l.to.col?null===(o=l.square)||void 0===o||o.move(l.to.row,5):2===l.to.col&&(null===(h=l.square)||void 0===h||h.move(l.to.row,3))),this.board.board[this.row][this.col]=null,this.board.board[i][s]=this,this.col=s,this.row=i,this.type===e.TYPE.PAWN&&l.isPromotion){let e=new t(this);this.elem.appendChild(e.getElement()),this.board.isolated=!0}return!0}return!1}checkMove(t){let i=this.side===e.SIDES.WHITE?this.board.whiteKing:this.board.blackKing;this.board.board[this.row][this.col]=null;let s=this.board.board[t.to.row][t.to.col];this.board.board[t.to.row][t.to.col]=this;let o=0===i.isChecked().length;return this.board.board[this.row][this.col]=this,this.board.board[t.to.row][t.to.col]=s,o}registerHandler(){this.elem.addEventListener("click",(()=>{this.board.selectPiece(this)}))}}e.SIDES={BLACK:"Black",WHITE:"White"},e.TYPE={PAWN:"Pawn",ROOK:"Rook",KNIGHT:"Knight",BISHOP:"Bishop",QUEEN:"Queen",KING:"King"};class i extends e{constructor(t,i,s,o){super(e.TYPE.KNIGHT,t,i,s,o)}getMoves(){let t=[];for(let e of[-2,2])for(let i of[-1,1]){let s=this.row+e,o=this.col+i;if(s>=0&&s<=7&&o>=0&&o<=7){let e=this.board.getPieceAt(s,o);(null==e?void 0:e.side)!==this.side&&t.push(new r(this,this.getPosition(),[s,o],e))}}for(let e of[-1,1])for(let i of[-2,2]){let s=this.row+e,o=this.col+i;if(s>=0&&s<=7&&o>=0&&o<=7){let e=this.board.getPieceAt(s,o);(null==e?void 0:e.side)!==this.side&&t.push(new r(this,this.getPosition(),[s,o],e))}}return t}}class s extends e{constructor(t,i,s,o){super(e.TYPE.QUEEN,t,i,s,o)}getMoves(){let t=[];for(let e=1;e<8;++e){let i=this.col+e;if(i>7)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[this.row,i],s));break}t.push(new r(this,this.getPosition(),[this.row,i],s))}for(let e=1;e<8;++e){let i=this.col-e;if(i<0)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[this.row,i],s));break}t.push(new r(this,this.getPosition(),[this.row,i],s))}for(let e=1;e<8;++e){let i=this.row+e;if(i>7)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[i,this.col],s));break}t.push(new r(this,this.getPosition(),[i,this.col],s))}for(let e=1;e<8;++e){let i=this.row-e;if(i<0)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[i,this.col],s));break}t.push(new r(this,this.getPosition(),[i,this.col],s))}for(let e=1;e<8;++e){let i=this.row+e,s=this.col+e;if(i>7||s>7)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}for(let e=1;e<8;++e){let i=this.row-e,s=this.col-e;if(i<0||s<0)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}for(let e=1;e<8;++e){let i=this.row-e,s=this.col+e;if(i<0||s>7)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}for(let e=1;e<8;++e){let i=this.row+e,s=this.col-e;if(i>7||s<0)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}return t}}class o extends e{constructor(t,i,s,o){super(e.TYPE.ROOK,t,i,s,o)}getMoves(){let t=[];for(let e=1;e<8;++e){let i=this.col+e;if(i>7)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[this.row,i],s));break}t.push(new r(this,this.getPosition(),[this.row,i],s))}for(let e=1;e<8;++e){let i=this.col-e;if(i<0)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[this.row,i],s));break}t.push(new r(this,this.getPosition(),[this.row,i],s))}for(let e=1;e<8;++e){let i=this.row+e;if(i>7)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[i,this.col],s));break}t.push(new r(this,this.getPosition(),[i,this.col],s))}for(let e=1;e<8;++e){let i=this.row-e;if(i<0)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&t.push(new r(this,this.getPosition(),[i,this.col],s));break}t.push(new r(this,this.getPosition(),[i,this.col],s))}return t}}class h extends e{constructor(t,i,s,o){super(e.TYPE.BISHOP,t,i,s,o)}getMoves(){let t=[];for(let e=1;e<8;++e){let i=this.row+e,s=this.col+e;if(i>7||s>7)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}for(let e=1;e<8;++e){let i=this.row-e,s=this.col-e;if(i<0||s<0)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}for(let e=1;e<8;++e){let i=this.row-e,s=this.col+e;if(i<0||s>7)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}for(let e=1;e<8;++e){let i=this.row+e,s=this.col-e;if(i>7||s<0)break;let o=this.board.getPieceAt(i,s);if(null!==o){o.side!==this.side&&t.push(new r(this,this.getPosition(),[i,s],o));break}t.push(new r(this,this.getPosition(),[i,s],o))}return t}}class l extends e{constructor(t,i,s,o){super(e.TYPE.PAWN,t,i,s,o),this.isMoved=!1}getMoves(){let t=[];for(let i=1;i<=(this.isMoved?1:2);++i){let s=this.side===e.SIDES.BLACK?i:-i,o=this.row+s;if(o>=0&&o<=7){let e=this.board.getPieceAt(o,this.col);if(null!==e)break;{let i=new r(this,this.getPosition(),[o,this.col],e);i.isPromotion=this.isPromoted(o),t.push(i)}}}let i=this.side===e.SIDES.BLACK?1:-1;for(let e of[-1,1]){let s=this.row+i,o=this.col+e;if(o>=0&&o<=7&&s>=0&&s<=7){let e=this.board.getPieceAt(s,o);if(null!==e&&e.side!==this.side){let i=new r(this,this.getPosition(),[s,o],e);i.isPromotion=this.isPromoted(s),t.push(i)}}}return t}isPromoted(t=this.row){return this.side===e.SIDES.BLACK&&7===t||this.side===e.SIDES.WHITE&&0==t}promoteTo(t){let l;switch(t){case e.TYPE.QUEEN:l=new s(this.side,this.board,this.row,this.col);break;case e.TYPE.KNIGHT:l=new i(this.side,this.board,this.row,this.col);break;case e.TYPE.ROOK:l=new o(this.side,this.board,this.row,this.col);break;case e.TYPE.BISHOP:l=new h(this.side,this.board,this.row,this.col);break;default:return void console.error("promotion peice type is invalid!")}l.isMoved=!0,this.board.board[this.row][this.col]=l,this.board.isolated=!1,this.board.game.drawBoard(),this.board.game.reverseTurn()}}class r{constructor(t,e,i,s,o=!1,h=!1,l=!1){this.piece=t,this.from={row:e[0],col:e[1]},this.to={row:i[0],col:i[1]},this.square=s,this.isCastle=o,this.isCheck=h,this.isPromotion=l}getNotation(){if(this.isCastle)return 6===this.to.col?"O-O":"O-O-O";let t="",e=this.piece.type[0];return this.piece instanceof i?e="N":this.piece instanceof l&&(e=""),t+=e,null!==this.square&&(this.piece instanceof l&&(t+=String.fromCharCode(97+this.from.col)),t+="x"),t+=String.fromCharCode(97+this.to.col),t+=8-this.to.row,this.isCheck&&(t+="+"),t}}class n extends e{constructor(t,i,s,o){super(e.TYPE.KING,t,i,s,o)}getMoves(){let t=[];for(let e=-1;e<=1;++e)for(let i=-1;i<=1;++i){if(0===e&&0===i)continue;let s=this.row+e,o=this.col+i;if(s>=0&&s<=7&&o>=0&&o<=7){let e=this.board.getPieceAt(s,o);if(null!==e&&e.side===this.side)continue;t.push(new r(this,this.getPosition(),[s,o],e))}}if(!this.isChecked().length){if(!this.isMoved){let e=!0;for(let t=1;t<=2;++t)if(null!==this.board.getPieceAt(this.row,this.col+t)){e=!1;break}let i=this.board.getPieceAt(this.row,this.col+3);e&&i&&i instanceof o&&!i.isMoved&&t.push(new r(this,this.getPosition(),[this.row,this.col+2],i,!0))}if(!this.isMoved){let e=!0;for(let t=1;t<=3;++t)if(null!==this.board.getPieceAt(this.row,this.col-t)){e=!1;break}let i=this.board.getPieceAt(this.row,this.col-4);e&&i&&i instanceof o&&!i.isMoved&&t.push(new r(this,this.getPosition(),[this.row,this.col-2],i,!0))}}return t}isChecked(){let t=[];for(let e=0;e<8;++e)for(let i=0;i<8;++i){let s=this.board.getPieceAt(e,i);if(s&&s.side!==this.side&&!(s instanceof n))for(let e of s.getMoves())e.square===this&&t.push(s)}return t}}class d{constructor(t){this.blackKing=new n(e.SIDES.BLACK,this,0,4),this.whiteKing=new n(e.SIDES.WHITE,this,7,4),this.board=this.initBoard(),this.selectedPiece=null,this.game=t,this.history=[],this.isolated=!1}initBoard(){return[[new o(e.SIDES.BLACK,this,0,0),new i(e.SIDES.BLACK,this,0,1),new h(e.SIDES.BLACK,this,0,2),new s(e.SIDES.BLACK,this,0,3),this.blackKing,new h(e.SIDES.BLACK,this,0,5),new i(e.SIDES.BLACK,this,0,6),new o(e.SIDES.BLACK,this,0,7)],[new l(e.SIDES.BLACK,this,1,0),new l(e.SIDES.BLACK,this,1,1),new l(e.SIDES.BLACK,this,1,2),new l(e.SIDES.BLACK,this,1,3),new l(e.SIDES.BLACK,this,1,4),new l(e.SIDES.BLACK,this,1,5),new l(e.SIDES.BLACK,this,1,6),new l(e.SIDES.BLACK,this,1,7)],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[new l(e.SIDES.WHITE,this,6,0),new l(e.SIDES.WHITE,this,6,1),new l(e.SIDES.WHITE,this,6,2),new l(e.SIDES.WHITE,this,6,3),new l(e.SIDES.WHITE,this,6,4),new l(e.SIDES.WHITE,this,6,5),new l(e.SIDES.WHITE,this,6,6),new l(e.SIDES.WHITE,this,6,7)],[new o(e.SIDES.WHITE,this,7,0),new i(e.SIDES.WHITE,this,7,1),new h(e.SIDES.WHITE,this,7,2),new s(e.SIDES.WHITE,this,7,3),this.whiteKing,new h(e.SIDES.WHITE,this,7,5),new i(e.SIDES.WHITE,this,7,6),new o(e.SIDES.WHITE,this,7,7)]]}getPieceAt(t,e){return this.board[t][e]}getSquare(t,e){return document.querySelector(`.square:nth-child(${8*t+e+1})`)}getElement(){let t=document.createElement("div");t.classList.add("board");let e=!0;for(let i=0;i<8;++i)for(let s=0;s<8;++s){let o=this.getPieceAt(i,s);0!==s&&(e=!e);let h=document.createElement("div");if(h.classList.add("square"),h.classList.add(e?"white":"black"),0==s){let t=document.createElement("div");t.classList.add("number-icon"),t.innerHTML=""+(8-i),t.style.color=e?"var(--black-square)":"var(--white-square)",h.appendChild(t)}if(7==i){let t=document.createElement("div");t.classList.add("char-icon"),t.innerHTML=`${String.fromCharCode(97+s)}`,t.style.color=e?"var(--black-square)":"var(--white-square)",h.appendChild(t)}null!==o&&(o instanceof n&&(o.isChecked().length?o.elem.classList.add("checked"):o.elem.classList.remove("checked")),h.appendChild(o.elem)),t.appendChild(h)}return t}selectPiece(t){if(this.game.turn===t.side&&!this.isolated){document.querySelectorAll(".highlighted").forEach((t=>{t.classList.remove("highlighted")})),this.selectedPiece=t;for(let e of t.getValidMoves()){this.highlightSquare(e.to.row,e.to.col);let t=this.getSquare(e.to.row,e.to.col);t&&(null==t||t.addEventListener("click",(()=>this.moveListener(e))))}}}moveListener(t){if(null!==this.selectedPiece&&this.selectedPiece.move(t.to.row,t.to.col)){for(let e of t.piece.getMoves())if(e.square instanceof n){t.isCheck=!0;break}this.history.push(t),this.selectedPiece.isMoved||(this.selectedPiece.isMoved=!0),this.selectedPiece=null,this.game.drawBoard(),t.isPromotion||this.game.reverseTurn()}}highlightSquare(t,e){let i=this.getSquare(t,e);null==i||i.classList.add("highlighted")}}let a=document.getElementById("game"),c=new class{constructor(t){this.elem=t,this.pieces=[],this.board=new d(this),this.turn=e.SIDES.WHITE}reverseTurn(){this.turn===e.SIDES.WHITE?this.turn=e.SIDES.BLACK:this.turn=e.SIDES.WHITE}drawBoard(){this.elem.innerHTML="",this.elem.appendChild(this.board.getElement());let t=document.createElement("div");if(t.classList.add("history"),this.board.history.length>0){let t=this.board.history[this.board.history.length-1];this.board.getSquare(t.from.row,t.from.col).classList.add("last-move"),this.board.getSquare(t.to.row,t.to.col).classList.add("last-move")}for(let e=0;e<this.board.history.length;++e){let i=this.board.history[e],s=document.createElement("div");s.innerHTML=`${e+1}.${i.getNotation()}`,t.appendChild(s)}this.elem.appendChild(t)}}(a);c.drawBoard()})();