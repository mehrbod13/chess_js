(()=>{"use strict";class e{constructor(e){this.pawn=e,this.options=[t.TYPE.QUEEN,t.TYPE.BISHOP,t.TYPE.KNIGHT,t.TYPE.ROOK]}getElement(){let e=document.createElement("div");e.classList.add("promo"),e.style.top=this.pawn.side===t.SIDES.WHITE?"-130%":"130%";for(let i of this.options){let s=document.createElement("div");s.classList.add("option"),s.addEventListener("click",(()=>{this.pawn.promoteTo(i)}));let h=document.createElement("img");h.setAttribute("src",t.getAssest(i,this.pawn.side)),s.appendChild(h),e.appendChild(s)}return e}}class t{static getAssest(e,t){return`./assets/${e}-${t}.svg`}constructor(e,t,i,s,h){this.type=e,this.side=t,this.board=i,this.row=s,this.col=h,this.elem=this.getElement(),this.registerHandler(),this.isMoved=!1}getElement(){let e=document.createElement("div");e.classList.add("piece");let i=document.createElement("img");return i.setAttribute("src",t.getAssest(this.type,this.side)),e.appendChild(i),e}getMoves(){return[]}getValidMoves(){return this.getMoves().filter((e=>{var i;return(null===(i=e.square)||void 0===i?void 0:i.type)!==t.TYPE.KING&&this.checkMove(e)}))}move(i,s){var h,l;for(let r of this.getValidMoves())if(s===r.col&&i===r.row){if(r.isCastle&&(6===r.col?null===(h=r.square)||void 0===h||h.move(r.row,5):2===r.col&&(null===(l=r.square)||void 0===l||l.move(r.row,3))),this.board.board[this.row][this.col]=null,this.board.board[i][s]=this,this.col=s,this.row=i,this.type===t.TYPE.PAWN&&r.isPromotion){let t=new e(this);this.elem.appendChild(t.getElement()),this.board.isolated=!0}return!0}return!1}checkMove(e){let i=this.side===t.SIDES.WHITE?this.board.whiteKing:this.board.blackKing;this.board.board[this.row][this.col]=null;let s=this.board.board[e.row][e.col];this.board.board[e.row][e.col]=this;let h=0===i.isChecked().length;return this.board.board[this.row][this.col]=this,this.board.board[e.row][e.col]=s,h}registerHandler(){this.elem.addEventListener("click",(()=>{this.board.selectPiece(this)}))}}t.SIDES={BLACK:"Black",WHITE:"White"},t.TYPE={PAWN:"Pawn",ROOK:"Rook",KNIGHT:"Knight",BISHOP:"Bishop",QUEEN:"Queen",KING:"King"};class i extends t{constructor(e,i,s,h){super(t.TYPE.KNIGHT,e,i,s,h)}getMoves(){let e=[];for(let t of[-2,2])for(let i of[-1,1]){let s=this.row+t,h=this.col+i;if(s>=0&&s<=7&&h>=0&&h<=7){let t=this.board.getPieceAt(s,h);(null==t?void 0:t.side)!==this.side&&e.push(new o(this,s,h,t))}}for(let t of[-1,1])for(let i of[-2,2]){let s=this.row+t,h=this.col+i;if(s>=0&&s<=7&&h>=0&&h<=7){let t=this.board.getPieceAt(s,h);(null==t?void 0:t.side)!==this.side&&e.push(new o(this,s,h,t))}}return e}}class s extends t{constructor(e,i,s,h){super(t.TYPE.QUEEN,e,i,s,h)}getMoves(){let e=[];for(let t=1;t<8;++t){let i=this.col+t;if(i>7)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&e.push(new o(this,this.row,i,s));break}e.push(new o(this,this.row,i,s))}for(let t=1;t<8;++t){let i=this.col-t;if(i<0)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&e.push(new o(this,this.row,i,s));break}e.push(new o(this,this.row,i,s))}for(let t=1;t<8;++t){let i=this.row+t;if(i>7)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&e.push(new o(this,i,this.col,s));break}e.push(new o(this,i,this.col,s))}for(let t=1;t<8;++t){let i=this.row-t;if(i<0)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&e.push(new o(this,i,this.col,s));break}e.push(new o(this,i,this.col,s))}for(let t=1;t<8;++t){let i=this.row+t,s=this.col+t;if(i>7||s>7)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}for(let t=1;t<8;++t){let i=this.row-t,s=this.col-t;if(i<0||s<0)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}for(let t=1;t<8;++t){let i=this.row-t,s=this.col+t;if(i<0||s>7)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}for(let t=1;t<8;++t){let i=this.row+t,s=this.col-t;if(i>7||s<0)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}return e}}class h extends t{constructor(e,i,s,h){super(t.TYPE.ROOK,e,i,s,h)}getMoves(){let e=[];for(let t=1;t<8;++t){let i=this.col+t;if(i>7)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&e.push(new o(this,this.row,i,s));break}e.push(new o(this,this.row,i,s))}for(let t=1;t<8;++t){let i=this.col-t;if(i<0)break;let s=this.board.getPieceAt(this.row,i);if(null!==s){s.side!==this.side&&e.push(new o(this,this.row,i,s));break}e.push(new o(this,this.row,i,s))}for(let t=1;t<8;++t){let i=this.row+t;if(i>7)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&e.push(new o(this,i,this.col,s));break}e.push(new o(this,i,this.col,s))}for(let t=1;t<8;++t){let i=this.row-t;if(i<0)break;let s=this.board.getPieceAt(i,this.col);if(null!==s){s.side!==this.side&&e.push(new o(this,i,this.col,s));break}e.push(new o(this,i,this.col,s))}return e}}class l extends t{constructor(e,i,s,h){super(t.TYPE.BISHOP,e,i,s,h)}getMoves(){let e=[];for(let t=1;t<8;++t){let i=this.row+t,s=this.col+t;if(i>7||s>7)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}for(let t=1;t<8;++t){let i=this.row-t,s=this.col-t;if(i<0||s<0)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}for(let t=1;t<8;++t){let i=this.row-t,s=this.col+t;if(i<0||s>7)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}for(let t=1;t<8;++t){let i=this.row+t,s=this.col-t;if(i>7||s<0)break;let h=this.board.getPieceAt(i,s);if(null!==h){h.side!==this.side&&e.push(new o(this,i,s,h));break}e.push(new o(this,i,s,h))}return e}}class r extends t{constructor(e,i,s,h){super(t.TYPE.PAWN,e,i,s,h),this.isMoved=!1}getMoves(){let e=[];for(let i=1;i<=(this.isMoved?1:2);++i){let s=this.side===t.SIDES.BLACK?i:-i,h=this.row+s;if(h>=0&&h<=7){let t=this.board.getPieceAt(h,this.col);if(null!==t)break;{let i=new o(this,h,this.col,t);i.isPromotion=this.isPromoted(h),e.push(i)}}}let i=this.side===t.SIDES.BLACK?1:-1;for(let t of[-1,1]){let s=this.row+i,h=this.col+t;if(h>=0&&h<=7&&s>=0&&s<=7){let t=this.board.getPieceAt(s,h);if(null!==t&&t.side!==this.side){let i=new o(this,s,h,t);i.isPromotion=this.isPromoted(s),e.push(i)}}}return e}isPromoted(e=this.row){return this.side===t.SIDES.BLACK&&7===e||this.side===t.SIDES.WHITE&&0==e}promoteTo(e){let r;switch(e){case t.TYPE.QUEEN:r=new s(this.side,this.board,this.row,this.col);break;case t.TYPE.KNIGHT:r=new i(this.side,this.board,this.row,this.col);break;case t.TYPE.ROOK:r=new h(this.side,this.board,this.row,this.col);break;case t.TYPE.BISHOP:r=new l(this.side,this.board,this.row,this.col);break;default:return void console.error("promotion peice type is invalid!")}r.isMoved=!0,this.board.board[this.row][this.col]=r,this.board.isolated=!1,this.board.game.drawBoard(),this.board.game.reverseTurn()}}class o{constructor(e,t,i,s,h=!1,l=!1,r=!1){this.piece=e,this.row=t,this.col=i,this.square=s,this.isCastle=h,this.isCheck=l,this.isPromotion=r}getNotation(){if(this.isCastle)return 6===this.col?"O-O":"O-O-O";let e="",t=this.piece.type[0];return this.piece instanceof i?t="N":this.piece instanceof r&&(t=""),e+=t,null!==this.square&&(this.piece instanceof r&&(e+=String.fromCharCode(97+this.piece.col)),e+="x"),e+=String.fromCharCode(97+this.col),e+=8-this.row,this.isCheck&&(e+="+"),e}}class n extends t{constructor(e,i,s,h){super(t.TYPE.KING,e,i,s,h)}getMoves(){let e=[];for(let t=-1;t<=1;++t)for(let i=-1;i<=1;++i){if(0===t&&0===i)continue;let s=this.row+t,h=this.col+i;if(s>=0&&s<=7&&h>=0&&h<=7){let t=this.board.getPieceAt(s,h);if(null!==t&&t.side===this.side)continue;e.push(new o(this,s,h,t))}}if(!this.isChecked().length){if(!this.isMoved){let t=!0;for(let e=1;e<=2;++e)if(null!==this.board.getPieceAt(this.row,this.col+e)){t=!1;break}let i=this.board.getPieceAt(this.row,this.col+3);t&&i&&i instanceof h&&!i.isMoved&&e.push(new o(this,this.row,this.col+2,i,!0))}if(!this.isMoved){let t=!0;for(let e=1;e<=3;++e)if(null!==this.board.getPieceAt(this.row,this.col-e)){t=!1;break}let i=this.board.getPieceAt(this.row,this.col-4);t&&i&&i instanceof h&&!i.isMoved&&e.push(new o(this,this.row,this.col-2,i,!0))}}return e}isChecked(){let e=[];for(let t=0;t<8;++t)for(let i=0;i<8;++i){let s=this.board.getPieceAt(t,i);if(s&&s.side!==this.side&&!(s instanceof n))for(let t of s.getMoves())t.square===this&&e.push(s)}return e}}class d{constructor(e){this.blackKing=new n(t.SIDES.BLACK,this,0,4),this.whiteKing=new n(t.SIDES.WHITE,this,7,4),this.board=this.initBoard(),this.selectedPiece=null,this.game=e,this.history=[],this.isolated=!1}initBoard(){return[[new h(t.SIDES.BLACK,this,0,0),new i(t.SIDES.BLACK,this,0,1),new l(t.SIDES.BLACK,this,0,2),new s(t.SIDES.BLACK,this,0,3),this.blackKing,new l(t.SIDES.BLACK,this,0,5),new i(t.SIDES.BLACK,this,0,6),new h(t.SIDES.BLACK,this,0,7)],[new r(t.SIDES.BLACK,this,1,0),new r(t.SIDES.BLACK,this,1,1),new r(t.SIDES.BLACK,this,1,2),new r(t.SIDES.BLACK,this,1,3),new r(t.SIDES.BLACK,this,1,4),new r(t.SIDES.BLACK,this,1,5),new r(t.SIDES.BLACK,this,1,6),new r(t.SIDES.BLACK,this,1,7)],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[new r(t.SIDES.WHITE,this,6,0),new r(t.SIDES.WHITE,this,6,1),new r(t.SIDES.WHITE,this,6,2),new r(t.SIDES.WHITE,this,6,3),new r(t.SIDES.WHITE,this,6,4),new r(t.SIDES.WHITE,this,6,5),new r(t.SIDES.WHITE,this,6,6),new r(t.SIDES.WHITE,this,6,7)],[new h(t.SIDES.WHITE,this,7,0),new i(t.SIDES.WHITE,this,7,1),new l(t.SIDES.WHITE,this,7,2),new s(t.SIDES.WHITE,this,7,3),this.whiteKing,new l(t.SIDES.WHITE,this,7,5),new i(t.SIDES.WHITE,this,7,6),new h(t.SIDES.WHITE,this,7,7)]]}getPieceAt(e,t){return this.board[e][t]}getSquare(e,t){return document.querySelector(`.square:nth-child(${8*e+t+1})`)}getElement(){let e=document.createElement("div");e.classList.add("board");let t=!0;for(let i=0;i<8;++i)for(let s=0;s<8;++s){let h=this.getPieceAt(i,s);0!==s&&(t=!t);let l=document.createElement("div");if(l.classList.add("square"),l.style.backgroundColor=t?"var(--white-square)":"var(--black-square)",0==s){let e=document.createElement("div");e.classList.add("number-icon"),e.innerHTML=""+(8-i),e.style.color=t?"var(--black-square)":"var(--white-square)",l.appendChild(e)}if(7==i){let e=document.createElement("div");e.classList.add("char-icon"),e.innerHTML=`${String.fromCharCode(97+s)}`,e.style.color=t?"var(--black-square)":"var(--white-square)",l.appendChild(e)}null!==h&&(h instanceof n&&(h.isChecked().length?h.elem.classList.add("checked"):h.elem.classList.remove("checked")),l.appendChild(h.elem)),e.appendChild(l)}return e}selectPiece(e){if(this.game.turn===e.side&&!this.isolated){document.querySelectorAll(".highlighted").forEach((e=>{e.classList.remove("highlighted")})),this.selectedPiece=e;for(let t of e.getValidMoves()){this.highlightSquare(t.row,t.col);let e=this.getSquare(t.row,t.col);e&&(null==e||e.addEventListener("click",(()=>this.moveListener(t))))}}}moveListener(e){if(null!==this.selectedPiece&&this.selectedPiece.move(e.row,e.col)){for(let t of e.piece.getMoves())if(t.square instanceof n){e.isCheck=!0;break}this.history.push(e),this.selectedPiece.isMoved||(this.selectedPiece.isMoved=!0),this.selectedPiece=null,this.game.drawBoard(),e.isPromotion||this.game.reverseTurn()}}highlightSquare(e,t){let i=this.getSquare(e,t);null==i||i.classList.add("highlighted")}}let a=document.getElementById("game"),c=new class{constructor(e){this.elem=e,this.pieces=[],this.board=new d(this),this.turn=t.SIDES.WHITE}reverseTurn(){this.turn===t.SIDES.WHITE?this.turn=t.SIDES.BLACK:this.turn=t.SIDES.WHITE}drawBoard(){this.elem.innerHTML="",this.elem.appendChild(this.board.getElement());let e=document.createElement("div");e.classList.add("history");for(let t=0;t<this.board.history.length;++t){let i=this.board.history[t],s=document.createElement("div");s.innerHTML=`${t+1}.${i.getNotation()}`,e.appendChild(s)}this.elem.appendChild(e)}}(a);c.drawBoard()})();